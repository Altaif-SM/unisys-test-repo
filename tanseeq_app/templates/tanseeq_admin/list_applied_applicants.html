{% extends "template_base_page.html" %}
{% load  i18n %}
{% load staticfiles %}

{% block styleBlock %}
    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    </head>
    <!-- END HEAD -->
    <style>
        div.dataTables_wrapper div.dataTables_filter label {
            font-weight: normal;
            white-space: nowrap;
            text-align: left;
            padding-top: 10px;
            padding-left: 30px;
        }

        div.dataTables_wrapper div.dataTables_length {
            padding-right: 40px;
            padding-top: 10px;
        }
    </style>
{% endblock %}

{% block ScriptBlock %}
    <script>
        window.onload = function () {
            $('#sample_1').dataTable().fnDestroy();
            /*
            $('#sample_1').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": "

            {% url 'tanseeq_app:list_applicant_filter' %}",
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, "All"]],
            pageLength: 10,
            dom: 'Blfrtip',
            buttons: [
                {
                    extend: 'excel',
                    exportOptions: {
                        columns: [0,1]
                    },

                },
                {
                    extend: 'csv',
                    exportOptions: {
                        columns: [0,1]
                    }
                },
            ],
            columnDefs: [
                {width: 50, targets: 0},
                {width: 100, targets: 1},

            ],
            fixedColumns: false,
            "order": [[0, "desc"]],
            "pagingType": "full_numbers",
            "oLanguage": {
                "oPaginate": {
                    "sFirst": "<<", // This is the link to the first page
                    "sPrevious": "<", // This is the link to the previous page
                    "sNext": ">", // This is the link to the next page
                    "sLast": ">>" // This is the link to the last page
                }
            }
        });*/


            $('#sample_1').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": "{% url 'tanseeq_app:list_applicant_filter' %}",
                columnDefs: [
                    {
                        data: "first_name", render: getFirstName,
                        orderable: true,
                        defaultContent: "",
                        targets: 3,
                        visible: true
                    },
                    {
                        data: "tanseeq_id", render: getTanseeqID,
                        orderable: true,
                        defaultContent: "",
                        targets: 2,
                        visible: true
                    },
                    {
                        data: "is_active", render: getStatusChange,
                        orderable: true,
                        defaultContent: "",
                        targets: 6,
                        visible: true
                    },

                    {orderable: false, targets: []}
                ],
                "order": [[0, "asc"]],
                "pagingType": "full_numbers",
                "oLanguage": {
                    "oPaginate": {
                        "sFirst": "<<", // This is the link to the first page
                        "sPrevious": "<", // This is the link to the previous page
                        "sNext": ">", // This is the link to the next page
                        "sLast": ">>" // This is the link to the last page
                    }
                }
            });


        }

        function getFirstName(data, type, full, meta) {
            return '<p>' + full[3] + '</p>'
        }

        function getTanseeqID(data, type, full, meta) {
            return '<a href="/tanseeq/personal_info_details/' + full[0] + '">' + full[2] + '</a>'
        }

        function getStatusChange(data, type, full, meta) {
            return '<button class="change_status btn-primary btn-xs type="button" status-url="/tanseeq/update_status/' + full[0] + '">Change Status</button>'
        }

        window.setTimeout(function () {
            $(".alert").fadeTo(500, 0).slideUp(500, function () {
                $(this).remove();
            });
        }, 4000);
    </script>
{% endblock %}

{% block content %}
    <div class="page-bar" style="margin-bottom: 1px;">
        <ul class="page-breadcrumb">
            <li>
                <i class="icon-home"></i>
                <a href="{% url 'tanseeq_app:tanseeq_student' %}">Home</a>
                <i class="fa fa-angle-right"></i>
            </li>
            <li>
                <span> {% trans 'Applicants List' %} </span>
            </li>
        </ul>
    </div>
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" role="alert" style="color: black;">{{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true"></button>
        </div>
    {% endfor %}
    <div class="portlet light portlet-fit portlet-form ">
        <div class="portlet-title">
            <div class="caption">
                <i class="icon-settings font-red"></i>
                <span class="caption-subject font-red sbold uppercase">
                {% trans 'Applicants List' %}
            </span>

            </div>
            <a href="{% url 'tanseeq_app:personal_info_details' %}">
                <button type="submit" class="btn green" id="save"
                        style="margin-left:68%;margin-bottom:10px;background-color: #3598dc"><i class="fa fa-plus"
                                                                                                aria-hidden="true"> New
                    Advanced</i>
                </button>
            </a>

        </div>
        <div class="portlet-body">
            <table class="table table-striped table-hover table-bordered" id="sample_1">
                <thead>
                <tr>
                    <th width="10%"> {% trans '# ID' %}</th>
                    <th width="10%"> {% trans 'Date' %}</th>
                    <th width="10%"> {% trans 'Tanseeq ID' %}</th>
                    <th> {% trans 'Applicant Name' %}</th>
                    <th> {% trans 'Created by' %}</th>
                    <th> {% trans 'Status' %}</th>
                    <th> {% trans 'Action' %}</th>
                </tr>
                </thead>
                <tbody id="tbody">
                {% for rec in object_list %}
                    <tr id="item{{ forloop.counter }}" class="item">
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- pop up modal -->
    <div id="id_status_model" class="modal fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title" style="color: #2a015e; text-align: center"><b>Change Application Status</b>
                    </h4>
                </div>
                <div class="modal-body">
                    <form id="id_update_fee_form">
                        <div class="row">
                            <div class="col-md-3 text-right control-label">
                                <label class="text-center">Status</label>
                            </div>
                            <div class="col-md-6">

                                <select id='id_status' title="Select Status"
                                        name="status"
                                        class="form-control" required>
                                    <option selected="selected" value="">{% trans 'Please Select' %}</option>

                                    <option value="Submitted">Submitted</option>
                                    <option value="Not Submitted">Not Submitted</option>

                                </select>

                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="id_status_cancel_model" data-dismiss="modal" class="btn dark btn-outline">
                        Cancel
                    </button>
                    <button type="button" id="id_confirm_status" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block ajax %}
    <script>


        $(document).on("click", ".change_status", function (e) {
            var application_status = $(this).closest('tr').find('.application_status').text().trim();
            $('#id_status').empty();
            $('#id_status').append(
                '<option value="' + application_status + '">'
                + application_status + '</option>');
            if (application_status == 'Not Submitted') {
                $('#id_status').append(
                    '<option value="Submitted">Submitted</option>');
            } else {
                $('#id_status').append(
                    '<option value="Not Submitted">Not Submitted</option>');
            }


            $("#id_status_model").modal()
            $("#id_confirm_status").attr("status-url", $(e.target).attr("status-url"))

        })


        $("#id_confirm_status").on("click", (e) => {
            $(e.target).attr('disabled', true)
            updateStaus($(e.target).attr("status-url"))
            $("#id_status_model").modal('hide')
        })


        function updateStaus(url) {
            const formData = new FormData($("#id_update_fee_form")[0])
            formData.set("status", formData.get("status").trim())
            $.ajax({
                type: 'PATCH',
                url: url,
                data: {
                    "status": formData.get("status")
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function (data, textStatus, xhr) {
                    if (xhr.status == 200) {
                        location.reload()
                    }
                },
                complete: function () {
                    $("#id_confirm_status").attr('disabled', false)
                },
                error: function (xhr, msg, err) {
                }
            });
        }
    </script>
    <script src="{% static 'tanseeq\admin\conditionFilters.js' %}" type="text/javascript"></script>
{% endblock %}