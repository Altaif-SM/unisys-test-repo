{% extends "template_base_page.html" %}
{% load staticfiles %}

{% block styleBlock %}
    <!-- BEGIN GLOBAL MANDATORY STYLES -->

    <link href="{% static 'assets/global/plugins/datatables/datatables.min.css' %}" rel="stylesheet" type="text/css"/>
    <link href="{% static 'assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css' %}"
          rel="stylesheet" type="text/css"/>

    </head>
    <!-- END HEAD -->
    <style type="text/css">

        div.dataTables_wrapper div.dataTables_filter label {
            font-weight: normal;
            white-space: nowrap;
            text-align: left;
            padding-top: 10px;
            padding-left: 30px;
        }

        div.dataTables_wrapper div.dataTables_length {
            padding-right: 40px;
            padding-top: 10px;
        }


    </style>
{% endblock %}

{% block ScriptBlock %}
    {#    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>#}
    <script>
        window.onload = function () {
            $(document).ready(function () {
                {#$(".chosen").chosen();#}
                $("#id_application").chosen();
                $("#id_country").chosen();

                $('#save').click(function () {
                    var array = []

                    $('.item').each(function (e) {
                        var id = $(this).attr('id');
                        var flags = {}

                        $('#' + id + ' .app').each(function () {
                            flags[$(this).attr('id')] = $(this).is(':checked')
                            {#alert($(this).is(':checked'));#}
                        })
                        {#alert($('#'+id+' .application_id').val())#}

                        var payload = {
                            'application_id': $('#' + id + ' .application_id').val(),
                            'flags': flags
                        }
                        array.push(payload)
                    })

                    $('#data_value').val(JSON.stringify(array));

                    {#console.log(JSON.stringify(array));#}
                    {#return false;#}
                })


                $(document).on("change", "#id_country", function (e) {
                    var country = $(this).val();
                    var url = '/partner/get_country_applications/';
                    get_country_applications(url, country)
                })


                function get_country_applications(url, country) {
                    $.ajax({
                        type: 'POST',
                        url: url,
                        data: {
                            country: country,
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success: function (data) {
                            $('#id_application').chosen('destroy');
                            $('#id_application').empty();


                            $('#id_application').prop("selectedIndex", -1);


                            $('#id_application').append('<option value="">Please select</option>');
                            for (var i = 0; i < data.length; i++) {
                                $('#id_application').append(
                                    '<option value="' + data[i]['id'] + '">'
                                    + data[i]['name'] + '</option>')
                            }
                            $('#id_application').chosen();
                        },
                        error: function (xhr, msg, err) {
                            alert(xhr.responseJSON.error);
                        }
                    });
                }
            });


            $('#sample_1').dataTable().fnDestroy();
            $('#sample_1').dataTable({
                "aoColumnDefs": [
                    {'bSortable': false}
                ]
            });
        }

        window.setTimeout(function () {
            $(".alert").fadeTo(500, 0).slideUp(500, function () {
                $(this).remove();
            });
        }, 4000);
    </script>

{% endblock %}

{% block content %}
    <div class="page-bar" style="margin-bottom: 1px;">
        <ul class="page-breadcrumb">
            <li>
                <i class="icon-home"></i>
                {% if user.is_student %}
                    <a href="{% url 'student:student_home' %}">Home</a>
                {% elif user.is_donor %}
                    <a href="{% url 'donor:template_donor_dashboard' %}">Home</a>
                {% elif user.is_parent %}
                    <a href="{% url 'parent:template_parent_dashboard' %}">Home</a>
                {% else %}
                    <a href="{% url 'accounts:home' %}">Home</a>
                {% endif %}
                <i class="fa fa-angle-right"></i>
            </li>
            {% if user.is_donor %}
                <li>
                    <span>Report </span>
                    <i class="fa fa-angle-right"></i>
                </li>
            {% endif %}

            <li>
                <span> Applicant Progress History </span>
            </li>
        </ul>
    </div>

    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" role="alert" style="color: black;">{{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true"></button>
        </div>
    {% endfor %}

    <!-- BEGIN VALIDATION STATES-->
    <div class="portlet light portlet-fit portlet-form ">
        <div class="portlet-title">
            <div class="caption">
                <i class="icon-settings font-red"></i>
                <span class="caption-subject font-red sbold uppercase">Applicant Progress History</span>
            </div>
        </div>

        <div class="portlet-body">
            <div class="form-body">
                <form method="post" {% if user.is_donor %}
                      action="{% url 'donor:filter_application_history' %}" {% elif user.is_parent %}
                      action="{% url 'parent:filter_application_history' %}"{% else %}
                      action="{% url 'partner:filter_application_history' %}" {% endif %} id="form_sample_1">
                    {% csrf_token %}
                    <div class="row col-md-offset-2">
                        <div class="">
                            {#                        <label style="margin-left: 3%" class="col-md-1 control-label">Country:</label>#}
                            <div class="col-md-2">
                                <select autocomplete="off" class="form-control" data-live-search="true"
                                        id="id_country" name="country">
                                    {% if country_obj %}
                                        <option style="display: none" value="{{ country_obj.id }}"
                                                selected="selected">{{ country_obj.country_name|title }}</option>
                                    {% else %}
                                        <option value="" style="display: none" selected="selected">Country</option>
                                    {% endif %}
                                    {#                            <option value="" style="display: none" >All</option>#}

                                    {% for rec in country_recs %}
                                        <option value="{{ rec.id }}">{{ rec.country_name|title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="">
                            {#                        <label class="col-md-1 control-label">Scholarship:</label>#}
                            <div class="col-md-2">
                                <select class="form-control"
                                        id="id_application" name="application" required="required">
                                    {% if application_obj %}
                                        <option style="display: none" value="{{ rec.id }}"
                                                selected="selected">{{ application_obj.get_full_name }}</option>
                                    {% else %}
                                        <option value="" style="display: none" selected="selected">Please Select
                                        </option>
                                    {% endif %}

                                    {% for rec in applicant_recs %}
                                        <option value="{{ rec.id }}">{{ rec.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="">
                            <div class="col-md-1">
                                <button type="submit" class="btn blue btn-block" id="go">Search</button>
                            </div>
                        </div>
                    </div>
                </form>


                {% comment %}<div class="row col-md-offset-3">
                <form method="post" {% if user.is_donor %} action="{% url 'donor:filter_application_history' %}" {% elif user.is_parent %} action="{% url 'parent:filter_application_history' %}"{% else %} action="{% url 'partner:filter_application_history' %}" {% endif %} id="form_sample_1">
                    {% csrf_token %}

                    <div class="col-md-4">
                        <div class="">
                            <select autocomplete="off" class="form-control" data-live-search="true"
                                    id="id_application" name="application" required="required">
                                {% if application_obj %}
                                    <option style="display: none" value="{{ rec.id }}"
                                            selected="selected">{{ application_obj.get_full_name }}</option>
                                {% else %}
                                    <option value="" style="display: none" selected="selected">Please Select</option>
                                {% endif %}

                                {% for rec in applicant_recs %}
                                    <option value="{{ rec.id }}">{{ rec.get_full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <button type="submit" class="btn blue btn-block" id="go">Search
                        </button>
                    </div>
                </form>
            </div>{% endcomment %}
                <div class="form-body">
                    <form id="form_sample_1" class="form-horizontal" method="POST" enctype="multipart/form-data"
                            {% comment %}action="{% url 'partner:change_application_status' %}"{% endcomment %}>
                        {% csrf_token %}

                        <div class="row">
                            <input hidden id="data_value" name="data_value">
                            <div class="">
                                <table class="table table-striped table-hover table-bordered" id="sample_1">
                                    <thead>
                                    <tr>
                                        <th style="display: none"></th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Remark</th>
                                    </tr>
                                    </thead>

                                    <tbody id="tbody">
                                    {% for rec in application_history_recs %}
                                        <tr id="item{{ forloop.counter }}" class="item">
                                            <td style="display: none"><input id="application_id" class="application_id"
                                                                             value="{{ rec.id }}"></td>

                                            <td>
                                                <text>{{ rec.last_updated|date:"d-m-Y" }}</text>
                                            </td>

                                            <td>
                                                <text>{{ rec.status }}</text>
                                            </td>

                                            <td>
                                                <text>{{ rec.remark }}</text>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
